{% extends 'base.html' %}
{% block content %}
<h3>Page 3 ‚Äì T·ªìn kho Th√†nh ph·∫©m & Xu·∫•t/Nh·∫≠p</h3>

<div class="container-fluid px-4">

  <!-- ====== CARD CH√çNH C√ì TAB ====== -->
  <div class="card mb-4">
    <div class="card-header">

      <!-- TAB MENU -->
      <ul class="nav nav-tabs card-header-tabs" id="fgTabs">
        <li class="nav-item">
          <a class="nav-link active" data-bs-toggle="tab" href="#tab-input">Ghi nh·∫≠t k√Ω</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="tab" href="#tab-log">Nh·∫≠t k√Ω xu·∫•t/nh·∫≠p</a>
        </li>
      </ul>

    </div>

    <div class="card-body tab-content">

      <!-- ======================= TAB 1 : GHI NH·∫¨T K√ù ======================= -->
      <div class="tab-pane fade show active" id="tab-input">

        <form method="post" action="{{ url_for('fg.fg_adjust') }}" id="multiForm">

          <table class="table table-bordered align-middle" id="txnTable">
            <thead>
              <tr class="table-light text-center">
                <th>Ng√†y</th>
                <th>Th√†nh ph·∫©m</th>
                <th>Nh·∫≠p</th>
                <th>Xu·∫•t</th>
                <th>Ghi ch√∫</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="txnBody">
              <tr>
                <td><input class="form-control" name="date[]" placeholder="01/11/25"></td>

                <td class="position-relative">
                  <input class="form-control product-input" placeholder="G√µ t√™n th√†nh ph·∫©m..." autocomplete="off">
                  <input type="hidden" name="product_id[]">
                  <div class="list-group position-absolute w-100 product-suggest"
                       style="z-index:3000; display:none; max-height:220px; overflow:auto;"></div>
                </td>

                <td><input class="form-control" type="number" step="0.0001" name="qty_in[]" value="0"></td>
                <td><input class="form-control" type="number" step="0.0001" name="qty_out[]" value="0"></td>
                <td><input class="form-control" name="note[]"></td>

                <td class="text-center">
                  <button type="button" class="btn btn-sm btn-outline-danger remove-row">üóë</button>
                </td>
              </tr>
            </tbody>
          </table>

          <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-outline-success btn-sm" id="addRow">‚ûï Th√™m d√≤ng</button>
            <button class="btn btn-primary">Ghi nh·∫≠n</button>
          </div>
        </form>

        <!-- data cho autocomplete -->
        <ul id="productsData" hidden>
          {% for p in products %}
            <li data-id="{{ p.id }}" data-name="{{ p.name }}" data-uom="{{ p.uom }}"></li>
          {% endfor %}
        </ul>

        <hr>

        <!-- ======================= IMPORT T·ªíN KHO ====================== -->
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Import t·ªìn kho t·ª´ Excel</span>
            <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('fg.fg_sample_template') }}">T·∫£i file m·∫´u</a>
          </div>
          <div class="card-body">
            <form method="post" action="{{ url_for('fg.import_fg_inventory') }}" enctype="multipart/form-data">
              <div class="row g-2">
                <div class="col-md-8"><input type="file" name="file" class="form-control" required></div>
                <div class="col-md-4 d-grid"><button class="btn btn-secondary">Import</button></div>
              </div>
              <div class="form-text">C·ªôt: product_name, uom, qty_on_hand</div>
            </form>
          </div>
        </div>

        <!-- ======================= T·ªíN KHO C·ªòNG D·ªíN ======================= -->
        <div class="card mt-3">
          <div class="card-header">Danh s√°ch t·ªìn kho (c·ªông d·ªìn)</div>
          <div class="card-body table-responsive">
            <table class="table table-striped table-sm align-middle">
              <thead>
                <tr><th>Th√†nh ph·∫©m</th><th>ƒêVT</th><th>T·ªìn kho</th></tr>
              </thead>
              <tbody>
                {% for inv in inventory %}
                <tr>
                  <td>{{ inv.product.name }}</td>
                  <td>{{ inv.product.uom }}</td>
                  <td>{{ "%.1f"|format(inv.qty_on_hand) }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

      </div>
      <!-- END TAB INPUT -->

      <!-- ======================= TAB 2 : NH·∫¨T K√ù ======================= -->
      <div class="tab-pane fade" id="tab-log">

        <div class="d-flex justify-content-between align-items-center">
          <h5>Nh·∫≠t k√Ω xu·∫•t nh·∫≠p Th√†nh ph·∫©m (500 d√≤ng g·∫ßn nh·∫•t)</h5>

          <div id="changeBar"
               class="d-flex gap-2 alert alert-warning align-items-center"
               style="display:none; background-color:#e8f5e9; border:1px solid #4caf50;">
            <span><strong id="changeCount">0</strong> thay ƒë·ªïi</span>
            <div class="d-flex gap-2 ms-3">
              <button id="saveChanges" class="btn btn-primary btn-sm">L∆∞u</button>
              <button id="discardChanges" class="btn btn-danger btn-sm">Hu·ª∑</button>
            </div>
          </div>

          <a class="btn btn-sm btn-outline-secondary"
             href="{{ url_for('fg.fg_export_logs',
                               f_product_id=f_product_id,
                               f_date_from=f_date_from,
                               f_date_to=f_date_to,
                               f_ref_type=f_ref_type) }}">
            Xu·∫•t Excel
          </a>
        </div>

        <!-- FORM L·ªåC -->
        <form class="row g-2 my-3" method="get" action="{{ url_for('fg.fg_page') }}">
          <div class="col-md-3">
            <label class="form-label">T·ª´ ng√†y</label>
            <input class="form-control" name="f_date_from" value="{{ f_date_from or '' }}">
          </div>

          <div class="col-md-3">
            <label class="form-label">ƒê·∫øn ng√†y</label>
            <input class="form-control" name="f_date_to" value="{{ f_date_to or '' }}">
          </div>

          <div class="col-md-3">
            <label class="form-label">Th√†nh ph·∫©m</label>
            <select class="form-select" name="f_product_id">
              <option value="0">-- T·∫•t c·∫£ --</option>
              {% for p in products %}
                <option value="{{ p.id }}" {% if f_product_id==p.id %}selected{% endif %}>{{ p.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-2">
            <label class="form-label">Ref type</label>
            <select class="form-select" name="f_ref_type">
              <option value="">-- T·∫•t c·∫£ --</option>
              <option value="Manual" {% if f_ref_type=='Manual' %}selected{% endif %}>Manual</option>
              <option value="Issue"  {% if f_ref_type=='Issue' %}selected{% endif %}>Issue</option>
            </select>
          </div>

          <div class="col-md-1 d-flex align-items-end">
            <button class="btn btn-primary w-100">L·ªçc</button>
          </div>
        </form>

        <!-- B·∫¢NG LOG -->
        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle">
            <thead>
              <tr>
                <th>Ng√†y th·ª±c t·∫ø</th>
                <th>Th√†nh ph·∫©m</th>
                <th>ƒêVT</th>
                <th>Nh·∫≠p</th>
                <th>Xu·∫•t</th>
                <th>Ghi ch√∫</th>
                <th>Ref type</th>
                <th>Ref ID</th>
                <th>Nh·∫≠p li·ªáu l√∫c</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for t in txns %}
              <tr data-id="{{ t.id }}">
                <td class="c-ts">{{ t.ts.strftime("%Y-%m-%d") }}</td>
                <td class="c-name">{{ t.product.name }}</td>
                <td class="c-uom">{{ t.uom }}</td>
                <td class="c-in">{{ '%.1f'|format(t.qty_in) }}</td>
                <td class="c-out">{{ '%.1f'|format(t.qty_out) }}</td>
                <td class="c-note">{{ t.note or '' }}</td>
                <td class="c-reftype">{{ t.ref_type or '' }}</td>
                <td class="c-refid">{{ t.ref_id or '' }}</td>
                <td class="c-entry">{{ t.entry_ts.strftime("%Y-%m-%d %H:%M") }}</td>
                <td class="c-actions">
                  <button class="btn btn-sm btn-outline-secondary me-1 edit-row">üõ†</button>
                  <button class="btn btn-sm btn-outline-danger delete-row">üóë</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
      <!-- END TAB LOG -->

    </div>
  </div>
</div>

<!-- JS t√¨m ki·∫øm g·ª£i √Ω (gi·ªëng inventory, ƒë·ªïi sang product) -->
<script>
(function(){
  const products = Array.from(document.querySelectorAll('#productsData > li')).map(el => ({
    id: el.dataset.id,
    name: el.dataset.name,
    norm: (el.dataset.name || '').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()
  }));

  function makeAutocomplete(row){
    const input = row.querySelector('.product-input');
    const hidden = row.querySelector('input[name="product_id[]"]');
    const suggest = row.querySelector('.product-suggest');
    let selectedIndex = -1;
    let currentList = [];

    function render(list){
      suggest.innerHTML = list.map((m,i)=>`
        <button type="button" class="list-group-item list-group-item-action ${i===selectedIndex?'active':''}" data-id="${m.id}">
          ${m.name}
        </button>
      `).join('');
      suggest.style.display = list.length?'block':'none';
    }

    function search(q){
      let text = q.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
      if (!text) return [];

      // t√°ch t·ª´: "2 l·ªõp shelton gi·∫•y v·ªá sinh" ‚Üí ["2","lop","shelton","giay","ve","sinh"]
      let parts = text.split(/\s+/).filter(x => x);

      return products
        .map(p => {
          let score = 0;
          let matched = true;

          for (let kw of parts) {
            if (p.norm.includes(kw)) {
              score++;
            } else {
              matched = false;
              break;
            }
          }

          return matched ? { ...p, score } : null;
        })
        .filter(x => x !== null)
        .sort((a, b) => b.score - a.score)   // ∆∞u ti√™n match nhi·ªÅu t·ª´ nh·∫•t
        .slice(0, 12);
    }


    input.addEventListener('input',()=>{
      const q = input.value;
      hidden.value = '';
      currentList = search(q);
      selectedIndex = -1;
      render(currentList);
    });

    input.addEventListener('keydown',e=>{
      if(suggest.style.display==='none') return;
      if(e.key==='ArrowDown'){ e.preventDefault(); selectedIndex = Math.min(selectedIndex+1, currentList.length-1); render(currentList); }
      else if(e.key==='ArrowUp'){ e.preventDefault(); selectedIndex = Math.max(selectedIndex-1, 0); render(currentList); }
      else if(e.key==='Enter'){
        e.preventDefault();
        if(selectedIndex>=0 && currentList[selectedIndex]) pick(currentList[selectedIndex]);
      }
    });

    suggest.addEventListener('mousedown',e=>{
      const btn = e.target.closest('button[data-id]');
      if(!btn) return;
      e.preventDefault();
      const id = btn.dataset.id;
      const p = products.find(x=>x.id===id);
      if(p) pick(p);
    });

    function pick(p){
      input.value = p.name;
      hidden.value = p.id;
      suggest.style.display='none';
    }

    input.addEventListener('blur',()=> setTimeout(()=> suggest.style.display='none', 100));
  }

  // √°p d·ª•ng cho t·∫•t c·∫£ c√°c d√≤ng
  document.querySelectorAll('#txnBody tr').forEach(makeAutocomplete);

  // th√™m d√≤ng m·ªõi
  document.getElementById('addRow').addEventListener('click',()=>{
    const tbody = document.getElementById('txnBody');
    const tr = tbody.rows[0].cloneNode(true);
    tr.querySelectorAll('input').forEach(i=>{ i.value=i.type==='number'?0:''; });
    tbody.appendChild(tr);
    makeAutocomplete(tr);
  });

  document.addEventListener('click',e=>{
    if(e.target.classList.contains('remove-row')){
      const tr = e.target.closest('tr');
      if(document.querySelectorAll('#txnBody tr').length>1) tr.remove();
    }
  });
})();
</script>

<!-- JS s·ª≠a/xo√° & l∆∞u thay ƒë·ªïi (g·∫ßn gi·ªëng inventory, g·ªçi endpoint fg) -->
<script>
(function(){
  const bar = document.getElementById('changeBar');
  const saveBtn = document.getElementById('saveChanges');
  const discardBtn = document.getElementById('discardChanges');
  const cnt = document.getElementById('changeCount');

  const edits = new Map();
  const deletes = new Set();

  function showBar(){ const total = edits.size + deletes.size; bar.style.display = total? 'flex':'none'; cnt.textContent = total; }
  function toInput(td, type, value){
    if(type==='date'){ td.innerHTML = `<input type="date" class="form-control form-control-sm" value="${(value||'').toString().slice(0,10)}">`; }
    else if(type==='number'){ td.innerHTML = `<input type="number" step="0.0001" class="form-control form-control-sm" value="${value}">`; }
    else { td.innerHTML = `<input type="text" class="form-control form-control-sm" value="${value||''}">`; }
    return td.querySelector('input');
  }
  function beginEdit(tr){
    if(tr.classList.contains('editing')) return; tr.classList.add('editing');
    const id = tr.dataset.id;
    const iTs   = toInput(tr.querySelector('.c-ts'),   'date',   tr.querySelector('.c-ts').textContent.trim());
    const iUom  = toInput(tr.querySelector('.c-uom'),  'text',   tr.querySelector('.c-uom').textContent.trim());
    const iIn   = toInput(tr.querySelector('.c-in'),   'number', tr.querySelector('.c-in').textContent.trim());
    const iOut  = toInput(tr.querySelector('.c-out'),  'number', tr.querySelector('.c-out').textContent.trim());
    const iNote = toInput(tr.querySelector('.c-note'), 'text',   tr.querySelector('.c-note').textContent.trim());
    function capture(){
      edits.set(id, { id:id, ts:iTs.value, uom:iUom.value,
                      qty_in:parseFloat(iIn.value||0), qty_out:parseFloat(iOut.value||0), note:iNote.value });
      if(deletes.has(id)){ deletes.delete(id); tr.classList.remove('table-danger','text-decoration-line-through'); }
      showBar();
    }
    [iTs,iUom,iIn,iOut,iNote].forEach(inp => inp.addEventListener('input', capture));
    capture();
  }
  function toggleDelete(tr){
    const id = tr.dataset.id;
    if(deletes.has(id)){ deletes.delete(id); tr.classList.remove('table-danger','text-decoration-line-through'); }
    else{ deletes.add(id); tr.classList.add('table-danger','text-decoration-line-through'); edits.delete(id); if(tr.classList.contains('editing')) location.reload(); }
    showBar();
  }
  document.addEventListener('click', (e)=>{
    const btnEdit = e.target.closest('.edit-row');
    const btnDel  = e.target.closest('.delete-row');
    if(btnEdit){ beginEdit(btnEdit.closest('tr')); }
    if(btnDel){  toggleDelete(btnDel.closest('tr')); }
  });
  discardBtn.addEventListener('click', ()=>{ edits.clear(); deletes.clear(); showBar(); location.reload(); });
  saveBtn.addEventListener('click', async ()=>{
    if(edits.size===0 && deletes.size===0) return;
    const ok = confirm(`C·∫≠p nh·∫≠t thay ƒë·ªïi?\n- S·ª≠a: ${edits.size} d√≤ng\n- Xo√°: ${deletes.size} d√≤ng`);
    if(!ok) return;
    try{
      const res = await fetch("{{ url_for('fg.fg_apply_log_changes') }}",{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ edits:[...edits.values()], deletes:[...deletes.values()] })
      });
      const j = await res.json();
      if(!res.ok || !j.ok){ alert("L·ªói: "+(j.error||res.statusText)); return; }
      alert("ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng."); location.reload();
    }catch(err){ alert("L·ªói m·∫°ng: "+err); }
  });
})();
</script>
<style>
  #txnTable td:nth-child(2), #txnTable th:nth-child(2) {
    width: 600px;
  }
  .product-input { width: 100%; min-width: 320px; }
  #txnTable td, #txnTable th {
    white-space: nowrap;
    vertical-align: middle;
  }
  .card + .card { margin-top: 1rem; }
</style>
{% endblock %}
