
{% extends 'base.html' %}
{% block content %}
<h3>Page 2 ‚Äì T·ªìn kho NVL & Xu·∫•t/Nh·∫≠p</h3>

<div class="container-fluid px-4">

  <!-- CARD CH√çNH C√ì TAB -->
  <div class="card mb-4">
    <div class="card-header">

      <!-- TABS -->
      <ul class="nav nav-tabs card-header-tabs" id="invTabs">
        <li class="nav-item">
          <a class="nav-link active" data-bs-toggle="tab" href="#tab-input">Ghi nh·∫≠t k√Ω</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="tab" href="#tab-log">Nh·∫≠t k√Ω xu·∫•t/nh·∫≠p NVL</a>
        </li>
      </ul>

    </div>

    <!-- N·ªòI DUNG C√ÅC TAB -->
    <div class="card-body tab-content">

      <!-- TAB 1: FORM GHI NH·∫¨T K√ù -->
      <div class="tab-pane fade show active" id="tab-input">

        <form method="post" action="{{ url_for('inventory.adjust') }}" id="multiForm">
          <table class="table table-bordered align-middle" id="txnTable">
            <thead>
              <tr class="table-light text-center">
                <th>Ng√†y</th>
                <th>Nguy√™n v·∫≠t li·ªáu</th>
                <th>Nh·∫≠p</th>
                <th>Xu·∫•t</th>
                <th>Ghi ch√∫</th>
                <th></th>
              </tr>
            </thead>

            <tbody id="txnBody">
              <tr>
                <td><input class="form-control" name="date[]" placeholder="01/11/25"></td>

                <td class="position-relative">
                  <input class="form-control material-input" placeholder="G√µ t√™n NVL..." autocomplete="off">
                  <input type="hidden" name="material_id[]">
                  <div class="list-group position-absolute w-100 material-suggest"
                       style="z-index:3000; display:none; max-height:220px; overflow:auto;"></div>
                </td>

                <td><input class="form-control" type="number" step="0.0001" name="qty_in[]" value="0"></td>
                <td><input class="form-control" type="number" step="0.0001" name="qty_out[]" value="0"></td>
                <td><input class="form-control" name="note[]"></td>

                <td class="text-center">
                  <button type="button" class="btn btn-sm btn-outline-danger remove-row">üóë</button>
                </td>
              </tr>
            </tbody>
          </table>

          <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-outline-success btn-sm" id="addRow">‚ûï Th√™m d√≤ng</button>
            <button class="btn btn-primary">Ghi nh·∫≠n</button>
          </div>
        </form>

        <!-- d·ªØ li·ªáu NVL -->
        <ul id="materialsData" hidden>
          {% for m in materials %}
            <li data-id="{{ m.id }}" data-name="{{ m.name }}" data-uom="{{ m.uom }}"></li>
          {% endfor %}
        </ul>

        <hr>

        <!-- IMPORT T·ªíN KHO -->
        <div class="card mt-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Import t·ªìn kho t·ª´ Excel</span>
            <a class="btn btn-sm btn-outline-secondary"
               href="{{ url_for('inventory.sample_template') }}">T·∫£i file m·∫´u</a>
          </div>

          <div class="card-body">
            <form method="post" action="{{ url_for('inventory.import_inventory') }}"
                  enctype="multipart/form-data">
              <div class="row g-2">
                <div class="col-md-8">
                  <input type="file" name="file" class="form-control" accept=".xlsx,.xls" required>
                </div>
                <div class="col-md-4 d-grid">
                  <button class="btn btn-secondary">Import</button>
                </div>
              </div>
              <div class="form-text">C·ªôt: material_name, uom, qty_on_hand</div>
            </form>
          </div>
        </div>

        <!-- T·ªíN KHO C·ªòNG D·ªíN -->
        <div class="card mt-3">
          <div class="card-header">Danh s√°ch t·ªìn kho (c·ªông d·ªìn)</div>
          <div class="card-body table-responsive">
            <table class="table table-striped table-sm align-middle">
              <thead>
                <tr><th>Nguy√™n v·∫≠t li·ªáu</th><th>ƒêVT</th><th>T·ªìn kho</th></tr>
              </thead>
              <tbody>
                {% for inv in inventory %}
                <tr>
                  <td>{{ inv.material.name }}</td>
                  <td>{{ inv.material.uom }}</td>
                  <td>{{ "%.1f"|format(inv.qty_on_hand) }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

      </div> <!-- END TAB INPUT -->


      <!-- TAB 2: NH·∫¨T K√ù XU·∫§T NH·∫¨P NVL -->
      <div class="tab-pane fade" id="tab-log">

        <div class="d-flex justify-content-between align-items-center">
          <h5>Nh·∫≠t k√Ω xu·∫•t nh·∫≠p NVL (500 d√≤ng g·∫ßn nh·∫•t)</h5>

          <div id="changeBar"
               class="d-flex gap-2 alert alert-warning align-items-center"
               style="display:none; background-color:#e8f5e9; border:1px solid #4caf50;">
            <div><strong id="changeCount">0</strong> thay ƒë·ªïi</div>
            <div class="d-flex gap-2 ms-3">
              <button id="saveChanges" class="btn btn-primary btn-sm">L∆∞u</button>
              <button id="discardChanges" class="btn btn-danger btn-sm">Hu·ª∑</button>
            </div>
          </div>

          <a class="btn btn-sm btn-outline-secondary"
             href="{{ url_for('inventory.export_logs',
                               f_material_id=f_material_id,
                               f_date_from=f_date_from,
                               f_date_to=f_date_to,
                               f_ref_type=f_ref_type) }}">
            Xu·∫•t Excel
          </a>
        </div>

        <!-- FORM L·ªåC LOG -->
        <form class="row g-2 my-3" method="get" action="{{ url_for('inventory.inv_page') }}">
          <div class="col-md-3">
            <label class="form-label">T·ª´ ng√†y</label>
            <input class="form-control" name="f_date_from" value="{{ f_date_from or '' }}">
          </div>

          <div class="col-md-3">
            <label class="form-label">ƒê·∫øn ng√†y</label>
            <input class="form-control" name="f_date_to" value="{{ f_date_to or '' }}">
          </div>

          <div class="col-md-3">
            <label class="form-label">Nguy√™n v·∫≠t li·ªáu</label>
            <select class="form-select" name="f_material_id">
              <option value="0">-- T·∫•t c·∫£ --</option>
              {% for m in materials %}
                <option value="{{ m.id }}" {% if f_material_id==m.id %}selected{% endif %}>{{ m.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-2">
            <label class="form-label">Ref type</label>
            <select class="form-select" name="f_ref_type">
              <option value="" {% if not f_ref_type %}selected{% endif %}>-- T·∫•t c·∫£ --</option>
              <option value="Manual" {% if f_ref_type=='Manual' %}selected{% endif %}>Manual</option>
              <option value="Issue"  {% if f_ref_type=='Issue' %}selected{% endif %}>Issue</option>
            </select>
          </div>

          <div class="col-md-1 d-flex align-items-end">
            <button class="btn btn-primary w-100">L·ªçc</button>
          </div>
        </form>

        <!-- B·∫¢NG LOG -->
        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle">
            <thead>
              <tr>
                <th>Ng√†y th·ª±c t·∫ø</th>
                <th>Nguy√™n v·∫≠t li·ªáu</th>
                <th>ƒêVT</th>
                <th>Nh·∫≠p</th>
                <th>Xu·∫•t</th>
                <th>Ghi ch√∫</th>
                <th>Ref type</th>
                <th>Ref ID</th>
                <th>Nh·∫≠p li·ªáu l√∫c</th>
                <th></th>
              </tr>
            </thead>

            <tbody>
              {% for t in txns %}
              <tr data-id="{{ t.id }}" data-material="{{ t.material_id }}">
                <td class="c-ts">{{ t.ts.strftime("%Y-%m-%d") }}</td>
                <td class="c-name">{{ t.material.name }}</td>
                <td class="c-uom">{{ t.uom }}</td>
                <td class="c-in">{{ '%.1f'|format(t.qty_in) }}</td>
                <td class="c-out">{{ '%.1f'|format(t.qty_out) }}</td>
                <td class="c-note">{{ t.note or '' }}</td>
                <td class="c-reftype">{{ t.ref_type or '' }}</td>
                <td class="c-refid">{{ t.ref_id or '' }}</td>
                <td class="c-entry">{{ t.entry_ts.strftime("%Y-%m-%d %H:%M") }}</td>
                <td class="c-actions">
                  <button class="btn btn-sm btn-outline-secondary me-1 edit-row" data-id="{{ t.id }}">üõ†</button>
                  <button class="btn btn-sm btn-outline-danger delete-row" data-id="{{ t.id }}">üóë</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>

          </table>
        </div>

      </div> <!-- END TAB LOG -->

    </div>
  </div>
</div>

<script>
(function(){
  const input  = document.getElementById('materialInput');
  const listEl = document.getElementById('materialSuggest');
  const hid    = document.getElementById('materialId');
  const help   = document.getElementById('materialHelp');

  // Chu·∫©n ho√°: b·ªè d·∫•u, lower-case ƒë·ªÉ t√¨m kh√¥ng ph√¢n bi·ªát d·∫•u
  function normalize(s){
    return (s || '').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
  }
  function escapeHtml(s){
    return (s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  }

  // L·∫•y danh s√°ch NVL t·ª´ th·∫ª ·∫©n
  const dataEls = document.querySelectorAll('#materialsData > li');
  const ITEMS = Array.from(dataEls).map(el => {
    const name = el.dataset.name || '';
    const uom  = el.dataset.uom  || '';
    return { id: el.dataset.id, label: `${name} (${uom})`, norm: normalize(name) };
  });

  let locked = false; // ƒë√£ ch·ªçn xong (kh√¥ng t·ª± ƒë·ªïi n·ªØa)

  function search(q){
    const nq = normalize(q);
    if(!nq) return [];
    const starts = ITEMS.filter(x => x.norm.startsWith(nq));
    return (starts.length ? starts : ITEMS.filter(x => x.norm.includes(nq))).slice(0, 10);
  }
  function show(list){
    if(!list.length){ listEl.style.display='none'; listEl.innerHTML=''; return; }
    listEl.innerHTML = list.map(it =>
      `<button type="button" class="list-group-item list-group-item-action" data-id="${it.id}">${escapeHtml(it.label)}</button>`
    ).join('');
    listEl.style.display = 'block';
  }
  function pick(it){
    locked = true;
    hid.value   = String(it.id);
    input.value = it.label;          // kho√° hi·ªÉn th·ªã theo l·ª±a ch·ªçn
    help.style.display = 'none';
    listEl.style.display = 'none';
  }

  // G√µ ƒë·ªÉ l·ªçc
  input.addEventListener('input', () => {
    locked = false;                   // ƒëang g√µ l·∫°i
    hid.value = '';
    help.style.display = 'none';
    show(search(input.value));
  });

  // Ch·ªçn b·∫±ng CHU·ªòT: d√πng mousedown ƒë·ªÉ kh√¥ng b·ªã blur m·∫•t click
  listEl.addEventListener('mousedown', (e) => {
    const btn = e.target.closest('button[data-id]');
    if (!btn) return;
    e.preventDefault();
    const id = btn.getAttribute('data-id');
    const it = ITEMS.find(x => String(x.id) === String(id));
    if (it) pick(it);
  });

  // Enter = ch·ªçn g·ª£i √Ω ƒë·∫ßu ti√™n
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter'){
      const results = search(input.value);
      if (results.length){
        e.preventDefault();
        pick(results[0]);
      }
    }
  });

  // Blur: n·∫øu ch∆∞a ch·ªçn th√¨ ch·ªâ ·∫©n list & hi·ªán nh·∫Øc; ƒë√£ ch·ªçn th√¨ gi·ªØ nguy√™n
  input.addEventListener('blur', () => {
    setTimeout(() => { listEl.style.display = 'none'; }, 120);
    if (!locked && !hid.value) help.style.display = 'block';
  });

  // Ch·∫∑n submit n·∫øu ch∆∞a c√≥ material_id h·ª£p l·ªá
  input.form?.addEventListener('submit', (e) => {
    if (!hid.value){
      e.preventDefault();
      help.style.display = 'block';
      input.focus();
    }
  });
})();
</script>
<script>
(function(){
  const bar = document.getElementById('changeBar');
  const saveBtn = document.getElementById('saveChanges');
  const discardBtn = document.getElementById('discardChanges');
  const cnt = document.getElementById('changeCount');

  const edits = new Map();    // id -> {id, ts, qty_in, qty_out, uom, note}
  const deletes = new Set();  // id

  function fmt(n){ return Number(n).toFixed(4); }
  function showBar(){ const total = edits.size + deletes.size; bar.style.display = total? 'flex':'none'; cnt.textContent = total; }

  function toInput(td, type, value){
    if(type==='date'){
      const v = (value||'').toString().slice(0,10);
      td.innerHTML = `<input type="date" class="form-control form-control-sm" value="${v}">`;
    }else if(type==='number'){
      td.innerHTML = `<input type="number" step="0.0001" class="form-control form-control-sm" value="${value}">`;
    }else{
      td.innerHTML = `<input type="text" class="form-control form-control-sm" value="${value||''}">`;
    }
    return td.querySelector('input');
  }

  function beginEdit(tr){
    if(tr.classList.contains('editing')) return;
    tr.classList.add('editing');
    const id = tr.dataset.id;

    const iTs   = toInput(tr.querySelector('.c-ts'),   'date',   tr.querySelector('.c-ts').textContent.trim());
    const iUom  = toInput(tr.querySelector('.c-uom'),  'text',   tr.querySelector('.c-uom').textContent.trim());
    const iIn   = toInput(tr.querySelector('.c-in'),   'number', tr.querySelector('.c-in').textContent.trim());
    const iOut  = toInput(tr.querySelector('.c-out'),  'number', tr.querySelector('.c-out').textContent.trim());
    const iNote = toInput(tr.querySelector('.c-note'), 'text',   tr.querySelector('.c-note').textContent.trim());

    function capture(){
      edits.set(id, {
        id: id,
        ts: iTs.value,
        uom: iUom.value,
        qty_in: parseFloat(iIn.value||0),
        qty_out: parseFloat(iOut.value||0),
        note: iNote.value
      });
      // n·∫øu ƒëang ƒë√°nh d·∫•u xo√° -> b·ªè xo√°
      if(deletes.has(id)) { deletes.delete(id); tr.classList.remove('table-danger','text-decoration-line-through'); }
      showBar();
    }
    [iTs,iUom,iIn,iOut,iNote].forEach(inp => inp.addEventListener('input', capture));
    capture();
  }

  function toggleDelete(tr){
    const id = tr.dataset.id;
    if(deletes.has(id)){
      deletes.delete(id);
      tr.classList.remove('table-danger','text-decoration-line-through');
    }else{
      deletes.add(id);
      tr.classList.add('table-danger','text-decoration-line-through');
      // n·∫øu ƒëang edit -> b·ªè edit
      edits.delete(id);
      if(tr.classList.contains('editing')) location.reload(); // ƒë∆°n gi·∫£n: reload ƒë·ªÉ b·ªè input
    }
    showBar();
  }

  // Delegate click
  document.addEventListener('click', (e)=>{
    const btnEdit = e.target.closest('.edit-row');
    const btnDel  = e.target.closest('.delete-row');
    if(btnEdit){
      const tr = btnEdit.closest('tr'); beginEdit(tr);
    }
    if(btnDel){
      const tr = btnDel.closest('tr'); toggleDelete(tr);
    }
  });

  discardBtn.addEventListener('click', ()=>{ edits.clear(); deletes.clear(); showBar(); location.reload(); });

  saveBtn.addEventListener('click', async ()=>{
    if(edits.size===0 && deletes.size===0) return;
    const ok = confirm("C·∫≠p nh·∫≠t thay ƒë·ªïi?\n- S·ª≠a: "+edits.size+" d√≤ng\n- Xo√°: "+deletes.size+" d√≤ng");
    if(!ok) return;
    try{
      const res = await fetch("{{ url_for('inventory.apply_log_changes') }}",{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ edits:[...edits.values()], deletes:[...deletes.values()] })
      });
      const j = await res.json();
      if(!res.ok || !j.ok){ alert("L·ªói: "+(j.error||res.statusText)); return; }
      alert("ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng.");
      location.reload();
    }catch(err){ alert("L·ªói m·∫°ng: "+err); }
  });

})();
</script>
<script>
(function(){
  const materials = Array.from(document.querySelectorAll('#materialsData > li')).map(el => ({
    id: el.dataset.id,
    name: el.dataset.name,
    norm: (el.dataset.name || '').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()
  }));

  function makeAutocomplete(row){
    const input = row.querySelector('.material-input');
    const hidden = row.querySelector('input[name="material_id[]"]');
    const suggest = row.querySelector('.material-suggest');
    let selectedIndex = -1;
    let currentList = [];

    function render(list){
      suggest.innerHTML = list.map((m,i)=>`
        <button type="button" class="list-group-item list-group-item-action ${i===selectedIndex?'active':''}" data-id="${m.id}">
          ${m.name}
        </button>
      `).join('');
      suggest.style.display = list.length?'block':'none';
    }

    function search(q){
      const nq = q.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
      if(!nq) return [];
      return materials.filter(m => m.norm.includes(nq));
    }

    input.addEventListener('input',()=>{
      const q = input.value;
      hidden.value = '';
      currentList = search(q);
      selectedIndex = -1;
      render(currentList);
    });

    input.addEventListener('keydown',e=>{
      if(suggest.style.display==='none') return;
      if(e.key==='ArrowDown'){ e.preventDefault(); selectedIndex = Math.min(selectedIndex+1, currentList.length-1); render(currentList); }
      else if(e.key==='ArrowUp'){ e.preventDefault(); selectedIndex = Math.max(selectedIndex-1, 0); render(currentList); }
      else if(e.key==='Enter'){
        e.preventDefault();
        if(selectedIndex>=0 && currentList[selectedIndex]){
          pick(currentList[selectedIndex]);
        }
      }
    });

    suggest.addEventListener('mousedown',e=>{
      const btn = e.target.closest('button[data-id]');
      if(!btn) return;
      e.preventDefault();
      const id = btn.dataset.id;
      const m = materials.find(x=>x.id===id);
      if(m) pick(m);
    });

    function pick(m){
      input.value = m.name;
      hidden.value = m.id;
      suggest.style.display='none';
    }

    input.addEventListener('blur',()=> setTimeout(()=> suggest.style.display='none', 100));
  }

  // apply autocomplete for all current rows
  document.querySelectorAll('#txnBody tr').forEach(makeAutocomplete);

  // add/remove row
  document.getElementById('addRow').addEventListener('click',()=>{
    const tbody = document.getElementById('txnBody');
    const tr = tbody.rows[0].cloneNode(true);
    tr.querySelectorAll('input').forEach(i=>{ i.value=i.type==='number'?0:''; });
    tbody.appendChild(tr);
    makeAutocomplete(tr);
  });

  document.addEventListener('click',e=>{
    if(e.target.classList.contains('remove-row')){
      const tr = e.target.closest('tr');
      if(document.querySelectorAll('#txnBody tr').length>1) tr.remove();
    }
  });
})();
</script>
<style>
  /* TƒÉng chi·ªÅu r·ªông ri√™ng cho √¥ ‚ÄúNguy√™n v·∫≠t li·ªáu‚Äù */
  #txnTable td:nth-child(2),
  #txnTable th:nth-child(2) {
    width: 500px;     /* üëà t√πy b·∫°n, v√≠ d·ª• 320px, 400px, 500px ƒë·ªÅu ƒë∆∞·ª£c */
  }

  /* Cho input b√™n trong d√£n full theo c·ªôt */
  .material-input {
    width: 100%;
    min-width: 320px;  /* üëà ƒë·∫£m b·∫£o kh√¥ng b·ªã co nh·ªè l·∫°i */
  }

  /* ƒê·∫£m b·∫£o ch·ªØ kh√¥ng b·ªã xu·ªëng d√≤ng trong c√°c √¥ */
  #txnTable td, #txnTable th {
    white-space: nowrap;
    vertical-align: middle;
  }
</style>
{% endblock %}
